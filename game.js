const mapDeck = [{
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-01.jpg",
        beacon1y: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-02.jpg",
        domeshelter: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-03.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-04.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-05.jpg",
        beacon2x: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-06.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-07.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front-base.jpg",
        back: "images/maptile-08.jpg",
        base: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-09.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-10.jpg",
        beacon3y: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-11.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-12.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-13.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-14.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-15.jpg",
        beacon1x: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-16.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-17.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-18.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-19.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-20.jpg",
        beacon2y: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-21.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-22.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-23.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-24.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-25.jpg",
        domeshelter: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-26.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-27.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-28.jpg",
        beacon3x: 1
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-29.jpg"
    },
    {
        location: 0,
        front: "images/maptile-front.jpg",
        back: "images/maptile-30.jpg"
    }
];

const eventDeck = [{
        id: 1,
        type: 1,
        title: "Crater Shadow",
        text: "text",  
        cardFace: "link",
        oxygenEffect: 0, 
        batteryEffect: -1,
        importance: 1
    },
    {
        id: 2,
        type: 1,
        title: "Crater Shadow",
        text: "text",
        cardFace: "link",
        oxygenEffect: 0, 
        batteryEffect: -1,
        importance: 9
    },
    {
        id: 3,
        type: 1,
        title: "Rough Terrain",
        text: "text",
        cardFace: "link",
        oxygenEffect: -2, 
        batteryEffect: 0,
        importance: 8
    },
    {
        id: 4,
        type: 1,
        title: "Rough Terrain",
        text: "text",
        cardFace: "link",
        oxygenEffect: -1, 
        batteryEffect: 0,
        importance: 2
    },
    {
        id: 5,
        type: 1,
        title: "Meteor Strike",
        text: "text",
        cardFace: "link",
        oxygenEffect: -1, 
        batteryEffect: 0,
        importance: 4
    },
    {
        id: 6,
        type: 1,
        title: "Static Charge",
        text: "text",
        cardFace: "link",
        oxygenEffect: 0, 
        batteryEffect: -1,
        importance: 3
    },
    {
        id: 7,
        type: 1,
        title: "Dust in Servomechs",
        text: "text",
        cardFace: "link",
        oxygenEffect: 0, 
        batteryEffect: -1,
        importance: 5
    },
    {
        id: 8,
        type: 1,
        title: "Suit Overheating",
        text: "text",
        cardFace: "link",
        oxygenEffect: -2, 
        batteryEffect: 0,
        importance: 6
    },
    {
        id: 9,
        type: 1,
        title: "Solar Wind",
        text: "text",
        cardFace: "link",
        oxygenEffect: 0, 
        batteryEffect: -2,
        importance: 7
    },
    {
        id: 10,
        type: 2,
        title: "Solar Recharge",
        cardFace: "link",
        effect: "Battery +2"
    },
    {
        id: 11,
        type: 2,
        title: "Solar Recharge",
        cardFace: "link",
        effect: "Battery +2"
    },
    {
        id: 12,
        type: 2,
        title: "Solar Recharge",
        cardFace: "link",
        effect: "Battery +2"
    },
    {
        id: 13,
        type: 3,
        title: "Jet Pack",
        cardFace: "link",
        effect: "Move to any explored tile. Battery -1"
    },
    {
        id: 14,
        type: 3,
        title: "Jet Pack",
        cardFace: "link",
        effect: "Move to any explored tile. Battery -1"
    },
    {
        id: 15,
        type: 3,
        title: "Jet Pack",
        cardFace: "link",
        effect: "Move to any explored tile. Battery -1"
    },
    {
        id: 16,
        type: 4,
        title: "Satellite Uplink",
        cardFace: "link",
        effect: "View next 6 cards in deck"
    }
];

const fuelTanks = {};

const player = {
    id: 1,
    location: 0,
    battery: 9,
    oxygen: 9,
    fuelTanksFound: 0
};

const discardDeck = [];
let currentEvent = [];
let currentEquipment = [];
let playerEquipment = [];
let turnCount = 0;

const gridElement = document.querySelector(".map-grid");

const playerToken = document.getElementById("player-token");

const playerstatsOxygenElement = document.getElementById("playerstats-oxygen");
const playerstatsBatteryElement = document.getElementById("playerstats-battery");
const playerstatsFuelTanksElement = document.getElementById("playerstats-fuel-tanks");

const messageTitleElement = document.getElementById("message-title");
const messageTextElement = document.getElementById("message-text");
const okButtonElement = document.getElementById("message-ok-button");
const cancelButtonElement = document.getElementById("message-cancel-button");
const oxygenButtonElement = document.getElementById("message-oxygen-button");
const batteryButtonElement = document.getElementById("message-battery-button");

function startGame() {
    shuffle(mapDeck);
    shuffle(eventDeck);
    buildGameBoard();
    findFuelTanks();
    playerStartingLocation();
    updatePlayerStats();
    movementPhase();
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function buildGameBoard() {
    let idx = 0;
    for (let row = 1; row < 6; row++) {
        for (let col = 1; col < 7; col++) {
            let coord = row.toString() + col.toString();
            mapDeck[idx].location = parseInt(coord);
            let maptile = document.createElement("div");
            maptile.classList.add("map-tile");
            maptile.setAttribute("id", coord);
            gridElement.appendChild(maptile);
            let maptileinner = document.createElement("div");
            maptileinner.classList.add("map-tile-inner");
            maptile.appendChild(maptileinner);
            let maptilefront = document.createElement("div");
            maptilefront.classList.add("map-tile-front");
            maptileinner.appendChild(maptilefront);
            let img = document.createElement("img");
            img.src = mapDeck[idx].front;
            maptilefront.appendChild(img);
            let maptileback = document.createElement("div");
            maptileback.classList.add("map-tile-back");
            maptileinner.appendChild(maptileback);
            let img2 = document.createElement("img");
            img2.src = mapDeck[idx].back;
            maptileback.appendChild(img2);
            idx++;
        }
    }
}

startGame();


function findFuelTanks() {
  //Note to self-- nicer way of doing this--
  //function that loops through an array of beacon1x, beacon1y...etc
  fuelTanks.beacon1x = mapDeck.find(card => card.beacon1x).location;    
  fuelTanks.beacon1y = mapDeck.find(card => card.beacon1y).location;
  fuelTanks.beacon2x = mapDeck.find(card => card.beacon2x).location;    
  fuelTanks.beacon2y = mapDeck.find(card => card.beacon2y).location;
  fuelTanks.beacon3x = mapDeck.find(card => card.beacon3x).location;    
  fuelTanks.beacon3y = mapDeck.find(card => card.beacon3y).location;
  fuelTanks.location1 = getIntersection(fuelTanks.beacon1x,fuelTanks.beacon1y);
  fuelTanks.location2 = getIntersection(fuelTanks.beacon2x,fuelTanks.beacon2y);
  fuelTanks.location3 = getIntersection(fuelTanks.beacon3x,fuelTanks.beacon3y);
}

function getIntersection(tileA,tileB) {
    let tileAy = tileA % 10;
    let tileAx = (tileA - tileAy) / 10;
    let tileBy = tileB % 10;
    let location = parseInt(tileAx.toString() + tileBy.toString());
    return location;
}

function playerStartingLocation() {
    player.location = mapDeck.find(card => card.base === 1).location;
    let path = calculatePath(22, player.location);
    movePlayer(player.location, path);
}

function updatePlayerStats() {
  playerstatsOxygenElement.innerText = `Oxygen: ${player.oxygen}`;
  playerstatsBatteryElement.innerText = `Battery: ${player.battery}`;
  playerstatsFuelTanksElement.innerText = `Fuel Tanks: ${player.fuelTanksFound}`;
}

function movementPhase() {
  turnCount++;
    //add click listener to actionMatchingCards button
    
    let possibleMoves = document.getElementsByClassName("map-tile");
    for (var i = 0; i < possibleMoves.length; i++) {
        possibleMoves[i].addEventListener('click', actionMove);
    }
  //remove click listener player.location map tile
}

function actionMove() {
    let destination = parseInt(this.id);
    //remove click listener from matchingCardsAction button
    //remove click listeners from all map tiles
    let path = calculatePath(player.location, destination);
    let movesNeeded = calculateMovesNeeded(path);
    if (movesNeeded < 3) {
        movePlayer(destination, path);
      eventPhase();
    } else {
        showMessageMovesNeeded(movesNeeded, destination, path);
    }
}


function movePlayer(destination, path) {
    if (path === undefined) {
        path = calculatePath();
    }
    let [moveHorizontal, moveVertical] = path;
    playerToken.style.transform += 'translateX(' + (moveHorizontal * 54) + 'px)';
    setTimeout( function() {
      playerToken.style.transform += 'translateY(' + (moveVertical * 54) + 'px)';
      document.getElementById(destination).classList.add("map-tile-is-flipped");
      player.location = destination;
      console.log("player new location", player.location);
  },400);
}

function calculatePath(location, destination) {
    let locy = location % 10;
    let locx = (location - locy) / 10;
    let desty = destination % 10;
    let destx = (destination - desty) / 10;
    let moveVertical = destx - locx;
    let moveHorizontal = desty - locy;
    return [moveHorizontal, moveVertical];
}

function calculateMovesNeeded(path) {
    let [moveHorizontal, moveVertical] = path;
    //Math.abs ensures number is positive
    let movesNeeded = Math.abs(moveHorizontal) + Math.abs(moveVertical);
    return movesNeeded;
}

function showMessageMovesNeeded(movesNeeded, destination, path) {
    showMessageSection();
    //hide unnecessary buttons
    
    cancelButtonElement.addEventListener('click', movementPhase);
    messageTitleElement.innerText = "Long Journey";
    messageTextElement.innerText = "That location is " + movesNeeded +
        " moves away. This will cost you Oxygen or Battery.";
    let counter = movesNeeded;
    //another function needs to handle player lowering own oxygen or 
    //battery values until counter is reduced to zero
    //on OK trigger function payForTheMove(destination,movesNeeded,path) 
  //remember to include in that function after moveplayer, eventPhase();
}

function showMessageSection() {
    //unhide message section
}

function hideMessageSection() {
    //hide message section
}

function eventPhase() {
    dealEventCards();
}

function dealEventCards() {
  let container = [];
    for (let i = 0; i < 3; i++) {        
      container = eventDeck.shift();     
        if (container.type === 1) {
            currentEvent.push(container);         
        } else {
            currentEquipment.push(container);
        }
    }
    if (eventDeck.length < 6) { //Must always have at least 6 cards in eventDeck...
        replenishEventDeck(); //...to allow SatelliteUplink action
    }
  handleEventCards();
}

function handleEventCards() {
  if (currentEvent.length > 1) {
        discardExcessEvents();
    } else {
      displayCurrentEvent();
    }    
}

function replenishEventDeck() {
  console.log("replenish is called")
  shuffle(discardDeck);
  eventDeck.push(...discardDeck.splice(0, discardDeck.length));
  console.log("discardDeck after replenish", discardDeck)
}

function discardExcessEvents() {
    currentEvent.sort(function(a, b) {
        return a.importance - b.importance;
    });
    while (currentEvent.length > 1) {
      discardDeck.push(currentEvent.shift());
    }
  displayCurrentEvent();
}

function displayCurrentEvent() {
    showMessageSection();
    //hide cancel button   
    let event = currentEvent[0];
    okButtonElement.addEventListener('click', displayCurrentEquipment);
    messageTitleElement.innerText = "Event: " + event.title;
    messageTextElement.innerText = event.text;
    player.oxygen += event.oxygenEffect; 
    player.battery += event.batteryEffect; 
    discardCurrentEvent();
    updatePlayerStats();
}

function discardCurrentEvent() {
  console.log(currentEvent)
  if (currentEvent.length < 2) {
    discardDeck.push(currentEvent.shift());
    console.log(currentEvent)
  } else {
    console.log("too many cards in currentevent")
  } 
}

function displayCurrentEquipment() {
    okButtonElement.addEventListener('click', updatePlayerEquipment);
    messageTitleElement.innerText = "You found new Equipment";
    messageTextElement.innerHTML = "";
    for (let i = 0; i < currentEquipment.length; i++) {
        messageTextElement.innerHTML += `<p>${currentEquipment[i].title}</p>`;
    }
}

function updatePlayerEquipment() {
    for (let i = 0; i < currentEquipment.length; i++) {
        playerEquipment.push(currentEquipment.shift());
    }
    matchingCardsCheck();
}

function matchingCardsCheck() {
    //check if player has matching cards in playerEquipment
    //if so allow player to use them
    //else 
  equipmentCheck();
}

function equipmentCheck() {
    //check no of cards in player's hand
    if (playerEquipment.length > 3) {
        console.log("You can only have 3 cards in your hand at the end of a turn. " +
            "You must discard " + (playerEquipment.length - 3) + " cards.");
        //trigger function to allow equipment card discards
    } else {
        systemsCheck();
    }
}

function systemsCheck() {
    if (player.battery < 1 || player.oxygen < 1) {
        console.log("You lost the game");
        endGame();
    } else {
        endTurn();
    }
}

function endTurn() {
    movementPhase();
}